# ===========================================
# Didin F√°cil - Alertmanager Configuration
# ===========================================
# Configura√ß√£o de roteamento e notifica√ß√£o de alertas
#
# Para configurar webhooks reais, defina as vari√°veis:
#   - SLACK_WEBHOOK_URL
#   - DISCORD_WEBHOOK_URL
# ===========================================

global:
  # Tempo limite para resolver alertas automaticamente
  resolve_timeout: 5m

  # Configura√ß√µes de Slack (opcional)
  # slack_api_url: '${SLACK_WEBHOOK_URL}'

# Templates personalizados
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Configura√ß√£o de roteamento
route:
  # Receptor padr√£o
  receiver: 'default-receiver'
  
  # Agrupamento de alertas
  group_by: ['alertname', 'hub', 'severity']
  
  # Tempo de espera antes de enviar primeiro alerta do grupo
  group_wait: 30s
  
  # Tempo de espera entre envios do mesmo grupo
  group_interval: 5m
  
  # Tempo de espera antes de reenviar um alerta
  repeat_interval: 4h
  
  # Rotas espec√≠ficas por severidade
  routes:
    # Alertas cr√≠ticos - notifica√ß√£o imediata
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h

    # Alertas de circuit breaker
    - match:
        alertname: HubCircuitBreakerOpen
      receiver: 'circuit-breaker-receiver'
      group_wait: 0s
      repeat_interval: 30m

    # Alertas de warning
    - match:
        severity: warning
      receiver: 'warning-receiver'
      repeat_interval: 6h

# Inibi√ß√£o de alertas (evitar duplicatas)
inhibit_rules:
  # Se um hub est√° com circuit breaker aberto, n√£o enviar outros alertas dele
  - source_match:
      alertname: HubCircuitBreakerOpen
    target_match_re:
      alertname: Hub.*
    equal: ['hub']

# Receptores de alertas
receivers:
  # Receptor padr√£o - apenas log
  - name: 'default-receiver'
    webhook_configs:
      - url: 'http://api:8000/internal/alerts/webhook'
        send_resolved: true

  # Receptor para alertas cr√≠ticos
  - name: 'critical-receiver'
    webhook_configs:
      - url: 'http://api:8000/internal/alerts/webhook'
        send_resolved: true
    # Descomente para habilitar Slack
    # slack_configs:
    #   - channel: '#alerts-critical'
    #     title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    #     send_resolved: true

  # Receptor para circuit breaker
  - name: 'circuit-breaker-receiver'
    webhook_configs:
      - url: 'http://api:8000/internal/alerts/webhook'
        send_resolved: true
    # Descomente para habilitar Slack
    # slack_configs:
    #   - channel: '#alerts-hubs'
    #     title: '‚ö° Circuit Breaker: {{ .GroupLabels.hub }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    #     send_resolved: true

  # Receptor para warnings
  - name: 'warning-receiver'
    webhook_configs:
      - url: 'http://api:8000/internal/alerts/webhook'
        send_resolved: true
