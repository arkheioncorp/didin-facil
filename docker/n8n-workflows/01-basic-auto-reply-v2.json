{
  "name": "01 - Auto Reply Simples (Sem Credenciais)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatwoot",
        "options": {
          "rawBody": false
        },
        "responseMode": "responseNode"
      },
      "id": "webhook-trigger",
      "name": "Webhook Chatwoot",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "chatwoot-webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\": \"received\"}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Responder Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [470, 180]
    },
    {
      "parameters": {
        "jsCode": "// Extrair dados do webhook do Chatwoot\nconst data = $input.first().json;\n\nconsole.log('Webhook recebido:', JSON.stringify(data));\n\n// Verificar se √© uma mensagem v√°lida\nif (data.event !== 'message_created') {\n  return [{ json: { skip: true, reason: 'not_message_created' } }];\n}\n\n// Verificar se √© mensagem recebida (n√£o enviada pelo agente)\nif (data.message_type !== 'incoming') {\n  return [{ json: { skip: true, reason: 'not_incoming' } }];\n}\n\n// Extrair informa√ß√µes importantes\nconst message = data.content || '';\nconst conversationId = data.conversation?.id;\nconst accountId = data.account?.id || 3;\nconst senderId = data.sender?.id;\nconst senderName = data.sender?.name || 'Cliente';\n\nif (!conversationId) {\n  return [{ json: { skip: true, reason: 'no_conversation_id' } }];\n}\n\nconsole.log(`Mensagem de ${senderName}: \"${message}\" (conv: ${conversationId})`);\n\n// Detectar tipo de mensagem\nlet responseType = 'unknown';\nlet responseMessage = '';\n\nconst messageLower = message.toLowerCase().trim();\n\n// Sauda√ß√µes\nif (/^(oi|ol√°|ola|bom dia|boa tarde|boa noite|hello|hi|hey|e ai|eai)/.test(messageLower)) {\n  responseType = 'greeting';\n  responseMessage = `üëã Ol√°${senderName !== 'Cliente' ? `, ${senderName}` : ''}! Bem-vindo ao *Didin F√°cil*!\\n\\nü§ñ Sou o assistente virtual e estou aqui para ajudar.\\n\\nDigite uma op√ß√£o:\\n\\n1Ô∏è‚É£ Comparar pre√ßos\\n2Ô∏è‚É£ Ver ofertas do dia\\n3Ô∏è‚É£ Falar com atendente\\n4Ô∏è‚É£ Hor√°rio de funcionamento`;\n}\n// Op√ß√£o 1 - Comparar pre√ßos\nelse if (messageLower === '1' || messageLower.includes('comparar') || messageLower.includes('pre√ßo')) {\n  responseType = 'compare';\n  responseMessage = `üîç *Compara√ß√£o de Pre√ßos*\\n\\nPara comparar pre√ßos, me envie o nome do produto que voc√™ est√° procurando!\\n\\nExemplos:\\n‚Ä¢ iPhone 15\\n‚Ä¢ Geladeira Brastemp\\n‚Ä¢ T√™nis Nike\\n\\nüí° Dica: Seja espec√≠fico para resultados melhores!`;\n}\n// Op√ß√£o 2 - Ofertas\nelse if (messageLower === '2' || messageLower.includes('oferta')) {\n  responseType = 'offers';\n  responseMessage = `üè∑Ô∏è *Ofertas do Dia*\\n\\nüî• Confira as melhores ofertas:\\n\\nüì± iPhone 14 - R$ 4.299 (12% OFF)\\nüíª Notebook Dell - R$ 3.199 (8% OFF)\\nüéß AirPods Pro - R$ 1.599 (15% OFF)\\n\\nüí¨ Quer detalhes de algum produto? Me envie o nome!`;\n}\n// Op√ß√£o 3 - Atendente\nelse if (messageLower === '3' || messageLower.includes('atendente') || messageLower.includes('humano')) {\n  responseType = 'agent';\n  responseMessage = `üë®‚Äçüíº *Atendimento Humano*\\n\\nUm momento! Estou transferindo voc√™ para um de nossos atendentes.\\n\\n‚è∞ Tempo m√©dio de espera: 2 minutos\\n\\nEnquanto isso, voc√™ pode continuar enviando suas d√∫vidas!`;\n}\n// Op√ß√£o 4 - Hor√°rio\nelse if (messageLower === '4' || messageLower.includes('hor√°rio') || messageLower.includes('horario') || messageLower.includes('funcionamento')) {\n  responseType = 'schedule';\n  responseMessage = `üïê *Hor√°rio de Funcionamento*\\n\\nüìÖ Segunda a Sexta: 8h √†s 18h\\nüìÖ S√°bado: 8h √†s 12h\\nüìÖ Domingo: Fechado\\n\\nü§ñ O assistente virtual funciona 24h!\\n\\nPosso ajudar em mais alguma coisa?`;\n}\n// Agradecimento\nelse if (/^(obrigad|valeu|thanks|vlw|brigad)/.test(messageLower)) {\n  responseType = 'thanks';\n  responseMessage = `üòä Por nada! Estamos aqui para ajudar!\\n\\nPrecisa de mais alguma coisa? √â s√≥ me chamar!\\n\\n‚≠ê N√£o esque√ßa de avaliar nosso atendimento!`;\n}\n// Mensagem n√£o reconhecida\nelse {\n  responseType = 'fallback';\n  responseMessage = `ü§î Desculpe, n√£o entendi sua mensagem.\\n\\nDigite uma das op√ß√µes abaixo:\\n\\n1Ô∏è‚É£ Comparar pre√ßos\\n2Ô∏è‚É£ Ver ofertas\\n3Ô∏è‚É£ Falar com atendente\\n4Ô∏è‚É£ Hor√°rio de funcionamento\\n\\nOu descreva o que voc√™ precisa!`;\n}\n\nreturn [{\n  json: {\n    skip: false,\n    conversationId,\n    accountId,\n    responseType,\n    responseMessage,\n    originalMessage: message,\n    senderName\n  }\n}];"
      },
      "id": "process-message",
      "name": "Processar Mensagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-skip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-should-respond",
      "name": "Deve Responder?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [690, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://tiktrend-chatwoot:3000/api/v1/accounts/{{ $json.accountId }}/conversations/{{ $json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "2nQ98Rj5MtwnMurVVfaoYN4t"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": {{ JSON.stringify($json.responseMessage) }},\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "send-response",
      "name": "Enviar Resposta Chatwoot",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [910, 300],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000
    },
    {
      "parameters": {
        "jsCode": "// Log do resultado\nconst input = $input.first().json;\nconsole.log('Resposta enviada com sucesso:', JSON.stringify(input));\nreturn [{ json: { success: true, ...input } }];"
      },
      "id": "log-success",
      "name": "Log Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1130, 300]
    }
  ],
  "connections": {
    "Webhook Chatwoot": {
      "main": [
        [
          {
            "node": "Responder Webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "Processar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Mensagem": {
      "main": [
        [
          {
            "node": "Deve Responder?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deve Responder?": {
      "main": [
        [
          {
            "node": "Enviar Resposta Chatwoot",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Enviar Resposta Chatwoot": {
      "main": [
        [
          {
            "node": "Log Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "v2",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "didin-facil"
  },
  "tags": [
    {
      "name": "Didin F√°cil",
      "createdAt": "2025-11-30T00:00:00.000Z"
    },
    {
      "name": "WhatsApp",
      "createdAt": "2025-11-30T00:00:00.000Z"
    },
    {
      "name": "Auto Reply",
      "createdAt": "2025-11-30T00:00:00.000Z"
    }
  ]
}
