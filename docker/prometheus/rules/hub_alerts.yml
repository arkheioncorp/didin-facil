# Prometheus Alert Rules - Hub Integration Alerts
# ==================================================
# Alertas para monitoramento dos Integration Hubs
# 
# Autor: TikTrend Finder
# Vers√£o: 1.0.0

groups:
  - name: hub_circuit_breaker_alerts
    interval: 30s
    rules:
      # ========================================
      # CIRCUIT BREAKER ALERTS
      # ========================================
      
      - alert: HubCircuitBreakerOpen
        expr: hub_circuit_breaker_state{state="open"} == 1
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "üî¥ Circuit Breaker ABERTO - {{ $labels.hub }}"
          description: |
            O circuit breaker do hub {{ $labels.hub }} est√° aberto h√° mais de 1 minuto.
            Isso significa que a integra√ß√£o est√° falhando consistentemente.
            
            A√ß√µes recomendadas:
            1. Verificar status do servi√ßo externo (Evolution API, Facebook API, TikTok API)
            2. Revisar logs para identificar a causa
            3. Se o servi√ßo externo estiver ok, resetar manualmente via API
          runbook_url: "https://docs.tiktrendfinder.com/runbooks/circuit-breaker-open"

      - alert: HubCircuitBreakerHalfOpen
        expr: hub_circuit_breaker_state{state="half_open"} == 1
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "üü° Circuit Breaker HALF-OPEN - {{ $labels.hub }}"
          description: |
            O circuit breaker do hub {{ $labels.hub }} est√° em half-open h√° mais de 5 minutos.
            O sistema est√° tentando recuperar, mas ainda n√£o conseguiu.
            
            Monitorar de perto.
          runbook_url: "https://docs.tiktrendfinder.com/runbooks/circuit-breaker-halfopen"

      # ========================================
      # SUCCESS RATE ALERTS
      # ========================================
      
      - alert: HubLowSuccessRate
        expr: |
          (
            hub_requests_success_total 
            / (hub_requests_success_total + hub_requests_failure_total)
          ) * 100 < 90
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "‚ö†Ô∏è Taxa de sucesso baixa - {{ $labels.hub }}"
          description: |
            O hub {{ $labels.hub }} tem taxa de sucesso abaixo de 90% nos √∫ltimos 5 minutos.
            Taxa atual: {{ printf "%.1f" $value }}%
            
            Verificar logs e status do servi√ßo externo.

      - alert: HubCriticalSuccessRate
        expr: |
          (
            hub_requests_success_total 
            / (hub_requests_success_total + hub_requests_failure_total)
          ) * 100 < 50
        for: 2m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "üî¥ Taxa de sucesso CR√çTICA - {{ $labels.hub }}"
          description: |
            O hub {{ $labels.hub }} tem taxa de sucesso abaixo de 50%.
            Taxa atual: {{ printf "%.1f" $value }}%
            
            A√á√ÉO IMEDIATA NECESS√ÅRIA!

      # ========================================
      # LATENCY ALERTS
      # ========================================
      
      - alert: HubHighLatency
        expr: hub_request_latency_p95_ms > 5000
        for: 3m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "üê¢ Lat√™ncia alta - {{ $labels.hub }}"
          description: |
            O hub {{ $labels.hub }} est√° com lat√™ncia P95 acima de 5 segundos.
            Lat√™ncia atual: {{ printf "%.0f" $value }}ms
            
            Poss√≠veis causas:
            - Servi√ßo externo lento
            - Rede congestionada
            - Rate limiting

      - alert: HubVeryHighLatency
        expr: hub_request_latency_p95_ms > 15000
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "üî¥ Lat√™ncia CR√çTICA - {{ $labels.hub }}"
          description: |
            O hub {{ $labels.hub }} est√° com lat√™ncia P95 acima de 15 segundos.
            Isso est√° impactando a experi√™ncia do usu√°rio.

      # ========================================
      # RATE LIMITING ALERTS
      # ========================================
      
      - alert: HubHighRateLimitRejections
        expr: |
          rate(hub_rate_limit_rejections_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "‚ö° Muitas rejei√ß√µes de rate limit - {{ $labels.hub }}"
          description: |
            O hub {{ $labels.hub }} est√° rejeitando mais de 10 requisi√ß√µes/min por rate limiting.
            Isso pode indicar:
            - Tr√°fego acima do esperado
            - Bot ou cliente mal-comportado
            - Configura√ß√£o de rate limit muito restritiva

  - name: hub_health_alerts
    interval: 1m
    rules:
      # ========================================
      # HEALTH STATUS ALERTS
      # ========================================
      
      - alert: HubUnhealthy
        expr: hub_health_status{status="unhealthy"} == 1
        for: 2m
        labels:
          severity: critical
          team: backend
          pagerduty: "true"
        annotations:
          summary: "üî¥ Hub UNHEALTHY - {{ $labels.hub }}"
          description: |
            O hub {{ $labels.hub }} est√° marcado como unhealthy h√° mais de 2 minutos.
            
            Este √© um alerta cr√≠tico que requer aten√ß√£o imediata.

      - alert: HubDegraded
        expr: hub_health_status{status="degraded"} == 1
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "üü° Hub DEGRADED - {{ $labels.hub }}"
          description: |
            O hub {{ $labels.hub }} est√° em estado degradado h√° mais de 5 minutos.
            
            O servi√ßo ainda est√° funcionando, mas com performance reduzida.

      # ========================================
      # NO DATA / SCRAPE FAILURE
      # ========================================
      
      - alert: HubMetricsNotAvailable
        expr: up{job="tiktrend-hubs"} == 0
        for: 5m
        labels:
          severity: critical
          team: devops
        annotations:
          summary: "üî¥ M√©tricas de Hub indispon√≠veis"
          description: |
            N√£o foi poss√≠vel coletar m√©tricas do endpoint /hub/metrics/prometheus
            h√° mais de 5 minutos.
            
            Verificar se a API est√° rodando e se o endpoint est√° acess√≠vel.
