name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  frontend-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Check Tauri invoke safety
        run: npm run lint:tauri

      - name: Unit Tests
        run: npm run test

  backend-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install ruff mypy pytest-cov

      - name: Ruff lint
        run: ruff check backend/

      - name: Unit Tests with Coverage
        run: |
          cd backend
          pytest tests/unit/ -v --cov=api --cov-report=xml --cov-report=term-missing

      - name: Security Tests
        run: |
          cd backend
          pytest tests/unit/test_security*.py tests/unit/test_license_service.py tests/unit/test_blacklist_service.py \
            -v \
            --cov=api.middleware \
            --cov=api.services.auth \
            --cov=api.services.blacklist \
            --cov=api.services.license \
            --cov=api.utils \
            --cov-report=term

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run E2E Tests
        run: npm run test:e2e

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  rust-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Cargo check
        working-directory: src-tauri
        run: cargo check

      - name: Cargo clippy
        working-directory: src-tauri
        run: cargo clippy -- -D warnings

      - name: Cargo test
        working-directory: src-tauri
        run: cargo test
